name: Deploy ARCBANK to GCP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Debug secrets
        run: |
          echo "SSH_HOST loaded -> ${{ secrets.SSH_HOST != '' }}"
          echo "SSH_USER loaded -> ${{ secrets.SSH_USER != '' }}"
          echo "SSH_PRIVATE_KEY loaded -> ${{ secrets.SSH_PRIVATE_KEY != '' }}"

      - name: Deploy ARCBANK via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 40m
          script: |
            echo "üìå Inicio de deploy ARCBANK: $(date)"

            # Crear swap si no existe
            if [ ! -f /swapfile ]; then
              echo "üìù Creando swap de 2GB..."
              sudo fallocate -l 2G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
            fi

            # Clonar o actualizar repositorio
            if [ ! -d ~/BancoArcbank ]; then
              echo "üì• Clonando repositorio ARCBANK..."
              cd ~
              git clone https://github.com/AlisonTamayo/BancoArcbank.git
            fi

            cd ~/BancoArcbank
            echo "üîÑ Actualizando c√≥digo desde main..."
            git fetch origin main
            git reset --hard origin/main
            git config --global --add safe.directory "*"

            # Preparar certificados
            echo "üîê Verificando certificados..."

            # mTLS para comunicaci√≥n microservices
            # Forzamos regeneraci√≥n si faltan la llave publica JWS (nueva feature)
            if [ ! -f ~/BancoArcbank/ms-transaccion/src/main/resources/certs/arcbank-public-key.pem ]; then
               rm -f ~/BancoArcbank/ms-transaccion/src/main/resources/certs/arcbank-keystore.p12
            fi

            if [ ! -f ~/BancoArcbank/ms-transaccion/src/main/resources/certs/arcbank-keystore.p12 ]; then
              echo "üìù Generando certificados mTLS y Llaves JWS..."
              chmod +x ~/BancoArcbank/generate-mtls-certs.sh
              ~/BancoArcbank/generate-mtls-certs.sh
            fi

            echo " ========================================================"
            echo " üîê INFORMACI√ìN DE SEGURIDAD PARA MIGRACI√ìN AWS (SWITCH) "
            echo " ========================================================"
            echo "1. API KEY (Header: 'apikey'):"
            echo "   Valor por defecto: ARCBANK_SECRET_KEY_2025_XYZ"
            echo "   (Verificar si se usa override en secrets)"
            echo ""
            echo "2. CERTIFICADO P√öBLICO (mTLS v1.3):"
            cat ~/BancoArcbank/ms-transaccion/src/main/resources/certs/arcbank-public-cert.pem
            echo ""
            echo "3. LLAVE P√öBLICA RSA (JWS / RS256):"
            cat ~/BancoArcbank/ms-transaccion/src/main/resources/certs/arcbank-public-key.pem
            echo " ========================================================"

            # Certificados SSL para Nginx (DuckDNS)
            echo "üåê Verificando certificados SSL para arcbank-bank.duckdns.org..."
            CERT_DIR="~/BancoArcbank/nginx/certs/live/arcbank-bank.duckdns.org"
            if [ ! -f $CERT_DIR/fullchain.pem ]; then
              echo "üõ°Ô∏è Certificado real no encontrado. Intentando obtener de Let's Encrypt..."
              
              # Detener Nginx si est√° corriendo para liberar el puerto 80
              sudo docker stop nginx-proxy-arcbank || true
              
              # Ejecutar Certbot Standalone
              sudo docker run --rm --name certbot \
                -p 80:80 \
                -v "$(pwd)/nginx/certs:/etc/letsencrypt" \
                -v "$(pwd)/nginx/certbot:/var/www/certbot" \
                certbot/certbot certonly --standalone \
                -d arcbank-bank.duckdns.org \
                --email alison.tamayo@gmail.com \
                --agree-tos --non-interactive --no-eff-email || echo "‚ö†Ô∏è Fall√≥ la obtenci√≥n autom√°tica."

              # Fallback: Si no se obtuvo el certificado real, crear uno temporal para que Nginx arranque
              if [ ! -f $CERT_DIR/fullchain.pem ]; then
                echo "üìù Creando certificado temporal (self-signed) para evitar errores de Nginx..."
                sudo mkdir -p $CERT_DIR
                sudo openssl req -x509 -nodes -days 7 -newkey rsa:2048 \
                  -keyout $CERT_DIR/privkey.pem \
                  -out $CERT_DIR/fullchain.pem \
                  -subj "/C=EC/ST=Pichincha/L=Quito/O=Arcbank/CN=arcbank-bank.duckdns.org"
              fi
            fi

            # Limpiar Docker antes del build
            echo "üßπ Limpiando im√°genes y contenedores antiguos..."
            sudo docker system prune -f

            # Construir y levantar con docker-compose (producci√≥n)
            echo "üöÄ Reiniciando servicios y limpiando basura..."
            sudo docker-compose -f docker-compose.prod.yml down --remove-orphans
            sudo docker-compose -f docker-compose.prod.yml build --no-cache
            sudo docker-compose -f docker-compose.prod.yml up -d --force-recreate

            # Reiniciar Nginx Proxy para aplicar certificados y configs
            echo "üîÑ Reiniciando Proxy Nginx..."
            sudo docker restart nginx-proxy-arcbank || true

            # Mostrar estado final de contenedores
            echo "üìä Estado actual de contenedores:"
            sudo docker ps

            echo "‚úÖ Deploy ARCBANK completado: $(date)"
