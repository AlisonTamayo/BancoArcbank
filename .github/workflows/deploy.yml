name: Deploy ARCBANK to GCP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 40m
          script: |
            # Entrar al directorio del proyecto (Corregido: BancoArcbank)
            cd ~/BancoArcbank || { echo "‚ùå Carpeta ~/BancoArcbank no encontrada"; exit 1; }
            
            # Asegurar que Git no d√© problemas de permisos
            git config --global --add safe.directory "*"
            
            # Actualizar c√≥digo
            echo "üì• Actualizando c√≥digo desde GitHub..."
            git reset --hard HEAD
            git pull origin main
            
            # Limpiar el sistema para evitar errores de espacio
            echo "üßπ Limpiando im√°genes y contenedores antiguos..."
            sudo docker system prune -f
            
            # Construir y levantar con Docker Compose
            # Se usa el archivo de producci√≥n
            echo "üöÄ Iniciando construcci√≥n y despliegue..."
            sudo docker-compose -f docker-compose.prod.yml build --no-cache
            sudo docker-compose -f docker-compose.prod.yml up -d --force-recreate --remove-orphans
            
            # Reiniciar Nginx (espec√≠ficamente por los mapeos de certificados y config)
            echo "üîÑ Reiniciando Proxy Nginx..."
            sudo docker restart nginx-proxy-arcbank || true
            
            # Reportar estado final
            echo "üìä Estado actual de los contenedores:"
            sudo docker ps
            
            echo "‚úÖ ARCBANK Deploy completado exitosamente: $(date)"
