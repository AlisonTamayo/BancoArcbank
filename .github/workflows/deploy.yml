name: Deploy ARCBANK to GCP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Debug secrets
        run: |
          echo "SSH_HOST loaded -> ${{ secrets.SSH_HOST != '' }}"
          echo "SSH_USER loaded -> ${{ secrets.SSH_USER != '' }}"
          echo "SSH_PRIVATE_KEY loaded -> ${{ secrets.SSH_PRIVATE_KEY != '' }}"

      - name: Deploy ARCBANK via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 40m
          script: |
            echo "ğŸ“Œ Inicio de deploy ARCBANK: $(date)"

            # Crear swap si no existe
            if [ ! -f /swapfile ]; then
              echo "ğŸ“ Creando swap de 2GB..."
              sudo fallocate -l 2G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
            fi

            # Clonar o actualizar repositorio
            if [ ! -d ~/BancoArcbank ]; then
              echo "ğŸ“¥ Clonando repositorio ARCBANK..."
              cd ~
              git clone https://github.com/AlisonTamayo/BancoArcbank.git
            fi

            cd ~/BancoArcbank
            echo "ğŸ”„ Actualizando cÃ³digo desde main..."
            git fetch origin main
            git reset --hard origin/main
            git config --global --add safe.directory "*"

            # Preparar certificados
            echo "ğŸ” Verificando certificados..."

            # mTLS para comunicaciÃ³n microservices
            # Forzamos regeneraciÃ³n si faltan la llave publica JWS (nueva feature)
            if [ ! -f ~/BancoArcbank/ms-transaccion/src/main/resources/certs/arcbank-public-key.pem ]; then
               echo "âš ï¸ Detectada falta de llave pÃºblica JWS. Eliminando keystore antiguo para forzar regeneraciÃ³n..."
               sudo rm -f ~/BancoArcbank/ms-transaccion/src/main/resources/certs/arcbank-keystore.p12
            fi

            if [ ! -f ~/BancoArcbank/ms-transaccion/src/main/resources/certs/arcbank-keystore.p12 ]; then
              echo "ğŸ“ Generando certificados mTLS y Llaves JWS..."
              cd ~/BancoArcbank
              chmod +x generate-mtls-certs.sh
              # Ejecutar con sudo desde el directorio correcto
              sudo bash generate-mtls-certs.sh
              
              # Verificar que se generaron correctamente
              if [ -f ~/BancoArcbank/ms-transaccion/src/main/resources/certs/arcbank-public-key.pem ]; then
                echo "âœ… Llave pÃºblica JWS generada correctamente."
              else
                echo "âŒ ERROR: La llave pÃºblica JWS no se generÃ³. Revisa los logs anteriores."
              fi
            fi

            echo " ========================================================"
            echo " ğŸ” INFORMACIÃ“N DE SEGURIDAD PARA MIGRACIÃ“N AWS (SWITCH) "
            echo " ========================================================"
            echo "1. API KEY (Header: 'apikey'):"
            echo "   Valor por defecto: ARCBANK_SECRET_KEY_2025_XYZ"
            echo "   (Verificar si se usa override en secrets)"
            echo ""
            echo "2. CERTIFICADO PÃšBLICO (mTLS v1.3):"
            cat ~/BancoArcbank/ms-transaccion/src/main/resources/certs/arcbank-public-cert.pem
            echo ""
            echo "3. LLAVE PÃšBLICA RSA (JWS / RS256):"
            cat ~/BancoArcbank/ms-transaccion/src/main/resources/certs/arcbank-public-key.pem
            echo " ========================================================"

            # Certificados SSL para Nginx (DuckDNS)
            echo "ğŸŒ Verificando certificados SSL para arcbank-bank.duckdns.org..."
            CERT_DIR="~/BancoArcbank/nginx/certs/live/arcbank-bank.duckdns.org"
            if [ ! -f $CERT_DIR/fullchain.pem ]; then
              echo "ğŸ›¡ï¸ Certificado real no encontrado. Intentando obtener de Let's Encrypt..."
              
              # Detener Nginx si estÃ¡ corriendo para liberar el puerto 80
              sudo docker stop nginx-proxy-arcbank || true
              
              # Ejecutar Certbot Standalone
              sudo docker run --rm --name certbot \
                -p 80:80 \
                -v "$(pwd)/nginx/certs:/etc/letsencrypt" \
                -v "$(pwd)/nginx/certbot:/var/www/certbot" \
                certbot/certbot certonly --standalone \
                -d arcbank-bank.duckdns.org \
                --email alison.tamayo@gmail.com \
                --agree-tos --non-interactive --no-eff-email || echo "âš ï¸ FallÃ³ la obtenciÃ³n automÃ¡tica."

              # Fallback: Si no se obtuvo el certificado real, crear uno temporal para que Nginx arranque
              if [ ! -f $CERT_DIR/fullchain.pem ]; then
                echo "ğŸ“ Creando certificado temporal (self-signed) para evitar errores de Nginx..."
                sudo mkdir -p $CERT_DIR
                sudo openssl req -x509 -nodes -days 7 -newkey rsa:2048 \
                  -keyout $CERT_DIR/privkey.pem \
                  -out $CERT_DIR/fullchain.pem \
                  -subj "/C=EC/ST=Pichincha/L=Quito/O=Arcbank/CN=arcbank-bank.duckdns.org"
              fi
            fi

            # Limpiar Docker antes del build
            echo "ğŸ§¹ Limpiando imÃ¡genes y contenedores antiguos..."
            sudo docker system prune -f

            # Asegurar que estamos en el directorio correcto
            cd ~/BancoArcbank
            echo "ğŸ“ Directorio actual: $(pwd)"
            echo "ğŸ“„ Verificando docker-compose.prod.yml existe:"
            ls -la docker-compose.prod.yml || echo "âŒ ERROR: docker-compose.prod.yml no encontrado!"

            # Construir y levantar con docker-compose (producciÃ³n)
            echo "ğŸš€ Reiniciando servicios..."
            sudo docker-compose -f docker-compose.prod.yml down --remove-orphans 2>&1 || echo "âš ï¸ Down fallÃ³ (puede ser normal si no habÃ­a contenedores)"
            
            echo "ğŸ”¨ Construyendo imÃ¡genes (esto puede tardar varios minutos)..."
            sudo docker-compose -f docker-compose.prod.yml build --no-cache 2>&1 || { echo "âŒ ERROR: Build fallÃ³!"; exit 1; }
            
            # Crear red externa si no existe (requerida por el compose)
            echo "ğŸŒ Verificando/creando red switch-network..."
            sudo docker network create switch-network 2>/dev/null || echo "   Red switch-network ya existe o fue creada."
            
            echo "ğŸš€ Levantando contenedores..."
            sudo docker-compose -f docker-compose.prod.yml up -d --force-recreate 2>&1 || { echo "âŒ ERROR: Up fallÃ³!"; exit 1; }

            # Reiniciar Nginx Proxy para aplicar certificados y configs
            echo "ğŸ”„ Reiniciando Proxy Nginx..."
            sudo docker restart nginx-proxy-arcbank || true

            # Mostrar estado final de contenedores
            echo "ğŸ“Š Estado actual de contenedores:"
            sudo docker ps

            echo "âœ… Deploy ARCBANK completado: $(date)"
