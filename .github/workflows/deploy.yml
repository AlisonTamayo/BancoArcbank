name: Deploy ARCBANK to GCP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Debug secrets
        run: |
          echo "SSH_HOST loaded -> ${{ secrets.SSH_HOST != '' }}"
          echo "SSH_USER loaded -> ${{ secrets.SSH_USER != '' }}"
          echo "SSH_PRIVATE_KEY loaded -> ${{ secrets.SSH_PRIVATE_KEY != '' }}"

      - name: Deploy ARCBANK via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 40m
          script: |
            echo "ğŸ“Œ Inicio de deploy ARCBANK: $(date)"

            # Crear swap si no existe
            if [ ! -f /swapfile ]; then
              echo "ğŸ“ Creando swap de 2GB..."
              sudo fallocate -l 2G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
            fi

            # Clonar o actualizar repositorio
            if [ ! -d ~/BancoArcbank ]; then
              echo "ğŸ“¥ Clonando repositorio ARCBANK..."
              cd ~
              git clone https://github.com/AlisonTamayo/BancoArcbank.git
            fi

            cd ~/BancoArcbank
            echo "ğŸ”„ Actualizando cÃ³digo desde main..."
            git fetch origin main
            git reset --hard origin/main
            git config --global --add safe.directory "*"

            # Preparar certificados
            echo "ğŸ” Verificando certificados..."

            # mTLS para comunicaciÃ³n microservices
            if [ ! -f ~/BancoArcbank/ms-transaccion/src/main/resources/certs/arcbank-keystore.p12 ]; then
              echo "ğŸ“ Generando certificados mTLS por defecto..."
              chmod +x ~/BancoArcbank/generate-mtls-certs.sh
              ~/BancoArcbank/generate-mtls-certs.sh
            fi

            # Certificados SSL para Nginx
            mkdir -p ~/BancoArcbank/nginx/certs
            if [ ! -f ~/BancoArcbank/nginx/certs/fullchain.pem ]; then
              echo "ğŸ“ Generando certificados SSL autofirmados para Nginx..."
              openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                -keyout ~/BancoArcbank/nginx/certs/privkey.pem \
                -out ~/BancoArcbank/nginx/certs/fullchain.pem \
                -subj "/C=EC/ST=Pichincha/L=Quito/O=Arcbank/CN=35.208.155.21"
            fi

            # Limpiar Docker antes del build
            echo "ğŸ§¹ Limpiando imÃ¡genes y contenedores antiguos..."
            sudo docker system prune -f

            # Construir y levantar con docker-compose (producciÃ³n)
            echo "ğŸš€ Construyendo y desplegando Docker Compose..."
            sudo docker-compose -f docker-compose.prod.yml build --no-cache
            sudo docker-compose -f docker-compose.prod.yml up -d --force-recreate --remove-orphans

            # Reiniciar Nginx Proxy para aplicar certificados y configs
            echo "ğŸ”„ Reiniciando Proxy Nginx..."
            sudo docker restart nginx-proxy-arcbank || true

            # Mostrar estado final de contenedores
            echo "ğŸ“Š Estado actual de contenedores:"
            sudo docker ps

            echo "âœ… Deploy ARCBANK completado: $(date)"
